{% extends "shared/layout.html" %}
{% block title %}Produkty ‚Äì Admin{% endblock %}

{% block content %}
<h1 class="mb-4">üì¶ Produkty</h1>

<div class="d-flex flex-wrap gap-2 align-items-center mb-3">
  <a href="{{ url_for('admin.add_product') }}" class="btn btn-success">‚ûï P≈ôidat produkt</a>
</div>

{# ‚Äî‚Äî‚Äî FILTRY NAD TABULKOU (u≈æ ne sticky, ≈æ√°dn√© p≈ôekr√Ωv√°n√≠) ‚Äî‚Äî‚Äî #}
<style>
  .filter-card{
    background: linear-gradient(135deg,#fafafa,#f5f7fb);
    border: 1px solid rgba(0,0,0,.06);
    box-shadow: 0 6px 18px rgba(0,0,0,.06);
    border-radius: 14px;
  }
  .filter-card .form-label{ font-weight:600; color:#374151; }
  .filter-actions .btn{ min-width:120px; }

  /* badge skladu ‚Äì ƒçistƒõ prezentace */
  .badge-stock{
    border-radius:9999px; padding:.35rem .6rem; font-size:.72rem; line-height:1;
    display:inline-block; white-space:nowrap; border:1px solid rgba(255,255,255,.12);
    box-shadow:0 4px 12px rgba(0,0,0,.08)
  }
  .badge-stock-ok{ color:#fff; background:linear-gradient(90deg,#34d399 0%,#059669 100%); box-shadow:0 6px 16px rgba(16,185,129,.25) }
  .badge-stock-low{ color:#111827; background:linear-gradient(90deg,#fcd34d 0%,#f59e0b 100%); box-shadow:0 6px 16px rgba(245,158,11,.18) }
  .badge-stock-oos{ color:#fff; background:linear-gradient(90deg,#ef4444 0%,#b91c1c 100%); box-shadow:0 6px 16px rgba(239,68,68,.25) }
</style>

<div class="filter-card p-3 mb-3">
  <form method="get" action="{{ url_for('admin.products') }}">
    <div class="row g-3 align-items-end">
      <div class="col-12 col-md-3">
        <label for="q" class="form-label mb-1">Hledat n√°zev</label>
        <input type="text" name="q" id="q" value="{{ q or '' }}" class="form-control" placeholder="nap≈ô. k≈ôi≈°≈•√°l‚Ä¶">
      </div>

      <div class="col-12 col-md-3">
        <label for="category_id" class="form-label mb-1">Kategorie</label>
        <select name="category_id" id="category_id" class="form-select">
          <option value="">‚Äî V≈°echny ‚Äî</option>
          {% for c in categories %}
            <option value="{{ c.id }}" {% if selected_category_id and selected_category_id == c.id %}selected{% endif %}>
              {{ c.group }} ‚Äî {{ c.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-6 col-md-2">
        <label for="price_min" class="form-label mb-1">Cena od</label>
        <input type="number" step="0.01" class="form-control" id="price_min" name="price_min" value="{{ price_min }}">
      </div>
      <div class="col-6 col-md-2">
        <label for="price_max" class="form-label mb-1">Cena do</label>
        <input type="number" step="0.01" class="form-control" id="price_max" name="price_max" value="{{ price_max }}">
      </div>

      <div class="col-6 col-md-2">
        <label for="stock_min" class="form-label mb-1">Sklad od</label>
        <input type="number" class="form-control" id="stock_min" name="stock_min" value="{{ stock_min }}">
      </div>
      <div class="col-6 col-md-2">
        <label for="stock_max" class="form-label mb-1">Sklad do</label>
        <input type="number" class="form-control" id="stock_max" name="stock_max" value="{{ stock_max }}">
      </div>

      <div class="col-12 col-md-3">
        <label for="sort" class="form-label mb-1">≈òazen√≠</label>
        <select name="sort" id="sort" class="form-select">
          <option value="id_desc"  {% if selected_sort == 'id_desc'  %}selected{% endif %}>Nejnovƒõj≈°√≠ (ID ‚Üì)</option>
          <option value="id_asc"   {% if selected_sort == 'id_asc'   %}selected{% endif %}>Nejstar≈°√≠ (ID ‚Üë)</option>
          <option value="date_desc"{% if selected_sort == 'date_desc'%}selected{% endif %}>Nejnovƒõj≈°√≠ (datum ‚Üì)</option>
          <option value="date_asc" {% if selected_sort == 'date_asc' %}selected{% endif %}>Nejstar≈°√≠ (datum ‚Üë)</option>
          <option value="name_asc" {% if selected_sort == 'name_asc' %}selected{% endif %}>N√°zev A‚ÜíZ</option>
          <option value="name_desc"{% if selected_sort == 'name_desc'%}selected{% endif %}>N√°zev Z‚ÜíA</option>
          <option value="price_asc"{% if selected_sort == 'price_asc'%}selected{% endif %}>Nejlevnƒõj≈°√≠</option>
          <option value="price_desc"{% if selected_sort == 'price_desc'%}selected{% endif %}>Nejdra≈æ≈°√≠</option>
        </select>
      </div>

      <div class="col-12 col-md-2">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="has_image" name="has_image" value="1" {% if selected_has_image %}checked{% endif %}>
          <label class="form-check-label" for="has_image">Jen s hlavn√≠m obr√°zkem</label>
        </div>
        <div class="form-check mt-1">
          <input class="form-check-input" type="checkbox" id="has_media" name="has_media" value="1" {% if selected_has_media %}checked{% endif %}>
          <label class="form-check-label" for="has_media">Jen s m√©dii</label>
        </div>
      </div>

      <div class="col-12 col-md-4 d-flex gap-2 justify-content-md-end filter-actions">
        <a href="{{ url_for('admin.products') }}" class="btn btn-outline-secondary">Reset filtr≈Ø</a>
        <button type="submit" class="btn btn-primary">Filtrovat</button>
      </div>
    </div>
  </form>
</div>

<table class="table table-bordered table-striped align-middle">
  <thead>
    <tr>
      <th>ID</th>
      <th>N√°zev</th>
      <th>Kategorie</th>
      <th>Cena</th>
      <th>Sklad</th>
      <th>Obr√°zek</th>
      <th>M√©dia</th>
      <th>Akce</th>
    </tr>
  </thead>
  <tbody>
    {% for p in products %}
    <tr>
      <td>{{ p.id }}</td>
      <td>{{ p.name }}</td>
      <td>
        {% if p.category %}
          {{ p.category.group }} ‚Äî {{ p.category.name }}
        {% else %}
          ‚Äî
        {% endif %}
      </td>
      <td>
        {% if p.price_czk is not none %}
          {{ '%.2f'|format(p.price_czk) }} Kƒç
        {% endif %}
      </td>
      <td>
        {% if p.stock > 5 %}
          <span class="badge badge-stock badge-stock-ok">Skladem: {{ p.stock }}</span>
        {% elif p.stock > 0 %}
          <span class="badge badge-stock badge-stock-low">Skladem: {{ p.stock }}</span>
        {% else %}
          <span class="badge badge-stock badge-stock-oos">Vyprod√°no</span>
        {% endif %}
      </td>
      <td>
        {% if p.image %}
          <div style="width:60px; height:60px; overflow:hidden; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.15);">
            <img src="{{ url_for('static', filename='uploads/' ~ p.image) }}" alt="n√°hled" style="width:100%; height:100%; object-fit:cover;">
          </div>
        {% endif %}
      </td>
      <td>
        {% if p.media %}
          {{ p.media|length }} soubor≈Ø
        {% else %}
          0
        {% endif %}
      </td>
      <td>
        <a href="{{ url_for('admin.edit_product', product_id=p.id) }}" class="btn btn-sm btn-primary">‚úèÔ∏è Upravit</a>
        <form action="{{ url_for('admin.delete_product', product_id=p.id) }}" method="post" class="d-inline"
              onsubmit="return confirm('Opravdu smazat tento produkt?');">
          <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è Smazat</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{# str√°nkov√°n√≠ ‚Äì p≈ôen√°≈°√≠ aktivn√≠ parametry #}
<nav aria-label="Str√°nkov√°n√≠" class="mt-3">
  <ul class="pagination">
    <li class="page-item {% if not has_prev %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('admin.products',
        page=1, q=q, category_id=selected_category_id,
        has_image=1 if selected_has_image else None,
        has_media=1 if selected_has_media else None,
        price_min=price_min, price_max=price_max,
        stock_min=stock_min, stock_max=stock_max,
        sort=selected_sort) }}">¬´ Prvn√≠</a>
    </li>
    <li class="page-item {% if not has_prev %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('admin.products',
        page=page-1, q=q, category_id=selected_category_id,
        has_image=1 if selected_has_image else None,
        has_media=1 if selected_has_media else None,
        price_min=price_min, price_max=price_max,
        stock_min=stock_min, stock_max=stock_max,
        sort=selected_sort) }}">‚Äπ P≈ôedchoz√≠</a>
    </li>
    <li class="page-item disabled"><span class="page-link">Strana {{ page }} / {{ max_pages }}</span></li>
    <li class="page-item {% if not has_next %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('admin.products',
        page=page+1, q=q, category_id=selected_category_id,
        has_image=1 if selected_has_image else None,
        has_media=1 if selected_has_media else None,
        price_min=price_min, price_max=price_max,
        stock_min=stock_min, stock_max=stock_max,
        sort=selected_sort) }}">Dal≈°√≠ ‚Ä∫</a>
    </li>
    <li class="page-item {% if not has_next %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('admin.products',
        page=max_pages, q=q, category_id=selected_category_id,
        has_image=1 if selected_has_image else None,
        has_media=1 if selected_has_media else None,
        price_min=price_min, price_max=price_max,
        stock_min=stock_min, stock_max=stock_max,
        sort=selected_sort) }}">Posledn√≠ ¬ª</a>
    </li>
  </ul>
</nav>
{% endblock %}
