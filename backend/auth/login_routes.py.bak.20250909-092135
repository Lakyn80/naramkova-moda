# backend/auth/login_routes.py
# âœ… Tento soubor obsluhuje pÅ™ihlÃ¡Å¡enÃ­/odhlÃ¡Å¡enÃ­
from flask import Blueprint, render_template, redirect, url_for, flash, request
from flask_login import login_user, logout_user, login_required

# PouÅ¾ijeme model s metodou user.check_password(...)
from backend.models.user import User

auth_bp = Blueprint("auth", __name__, url_prefix="/auth")

# â”€â”€â”€ PÅ™ihlÃ¡Å¡enÃ­ uÅ¾ivatele â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@auth_bp.route("/login", methods=["GET", "POST"])
def login():
    """
    ZobrazÃ­ pÅ™ihlaÅ¡ovacÃ­ formulÃ¡Å™ a zpracuje pÅ™ihlÃ¡Å¡enÃ­ uÅ¾ivatele.
    """
    if request.method == "POST":
        username = (request.form.get("username") or "").strip()
        password = (request.form.get("password") or "").strip()

        # VyhledÃ¡nÃ­ uÅ¾ivatele podle username
        user = User.query.filter_by(username=username).first()

        # âœ… OvÄ›Å™enÃ­ hesla pÅ™es model (umÃ­ bcrypt i starÃ½ werkzeug hash)
        if user and user.check_password(password):
            login_user(user)
            flash("âœ… PÅ™ihlÃ¡Å¡enÃ­ probÄ›hlo ÃºspÄ›Å¡nÄ›.", "success")
            return redirect(url_for("admin.dashboard"))
        else:
            flash("âŒ NeplatnÃ© pÅ™ihlaÅ¡ovacÃ­ Ãºdaje.", "danger")

    return render_template("admin/auth/login.html")

# â”€â”€â”€ OdhlÃ¡Å¡enÃ­ uÅ¾ivatele â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@auth_bp.route("/logout", methods=["GET", "POST"])
@login_required
def logout():
    """
    OdhlÃ¡sÃ­ uÅ¾ivatele a pÅ™esmÄ›ruje zpÄ›t na login strÃ¡nku.
    """
    logout_user()
    flash("ğŸŸ¡ Byli jste odhlÃ¡Å¡eni.", "info")
    return redirect(url_for("auth.login"))
